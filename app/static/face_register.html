<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Registrasi Wajah Otomatis</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-50 min-h-screen flex items-center justify-center px-4">
    <div class="w-full max-w-sm mx-auto bg-white p-6 rounded-xl shadow-md text-center">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">Registrasi Wajah</h2>

      <video id="video" class="w-full rounded-lg border border-gray-300 mb-2" autoplay muted></video>
      <canvas id="canvas" class="hidden" width="480" height="360"></canvas>

      <div class="mb-3">
        <input
          type="text"
          id="userIdInput"
          placeholder="Masukkan User ID"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"
        />
      </div>

      <button
        id="startBtn"
        class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition"
      >
        Mulai Registrasi
      </button>

      <div
        id="status"
        class="mt-4 text-sm font-medium text-gray-700 bg-gray-100 p-3 rounded-lg"
      >
        Menunggu input...
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

    <script>
      const video = document.getElementById("video");
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");
      const status = document.getElementById("status");
      const startBtn = document.getElementById("startBtn");
      const userIdInput = document.getElementById("userIdInput");

      const directions = ["front", "left", "right", "up", "down"];
      let currentDir = 0;
      let capturedImages = [];
      let timer = null;
      let lastDirection = "";

      const faceM = new FaceMesh({
        locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`,
      });

      faceM.setOptions({
        maxNumFaces: 1,
        refineLandmarks: true,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5,
      });

      faceM.onResults(onResults);

      let camera;

      startBtn.onclick = async () => {
        const userId = userIdInput.value.trim();
        if (!userId) {
          alert("User ID wajib diisi.");
          return;
        }

        startBtn.disabled = true;
        userIdInput.disabled = true;
        status.innerText = `Arahkan wajah ke: ${directions[currentDir].toUpperCase()}`;

        camera = new Camera(video, {
          onFrame: async () => await faceM.send({ image: video }),
          width: 480,
          height: 360,
        });

        camera.start();
      };

      function getDirection(landmarks) {
        const left = landmarks[33];
        const right = landmarks[263];
        const nose = landmarks[1];

        const dx = right.x - left.x;
        const noseOffset = nose.x - (left.x + right.x) / 2;
        const dy = nose.y - (landmarks[152].y + landmarks[10].y) / 2;

        if (noseOffset > 0.02) return "left";
        if (noseOffset < -0.02) return "right";
        if (dy < -0.03) return "up";
        if (dy > 0.03) return "down";
        return "front";
      }

      function onResults(results) {
        if (!results.multiFaceLandmarks || results.multiFaceLandmarks.length === 0) return;

        const detectedDir = getDirection(results.multiFaceLandmarks[0]);

        status.innerText = `Arahkan wajah ke: ${directions[currentDir].toUpperCase()} (Terdeteksi: ${detectedDir})`;

        if (detectedDir === directions[currentDir]) {
          if (lastDirection !== detectedDir) {
            lastDirection = detectedDir;

            timer = setTimeout(() => {
              captureImage();
              lastDirection = "";
            }, 1000);
          }
        } else {
          clearTimeout(timer);
          lastDirection = "";
        }
      }

      function captureImage() {
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        canvas.toBlob((blob) => {
          capturedImages.push(blob);
          currentDir++;

          if (currentDir >= directions.length) {
            camera.stop();
            status.innerText = "✅ Semua gambar berhasil diambil!";
            sendImagesToBackend();
          } else {
            status.innerText = `✅ Gambar tersimpan! Sekarang arahkan wajah ke: ${directions[currentDir].toUpperCase()}`;
          }
        }, "image/jpeg");
      }

      function sendImagesToBackend() {
        const formData = new FormData();
        capturedImages.forEach((blob, index) => {
          formData.append("images", blob, `img${index}.jpg`);
        });

        const userId = userIdInput.value.trim();
        formData.append("user_id", userId);

        status.innerText = "Mengirim gambar ke server...";

        fetch("/api/register-face", {
          method: "POST",
          body: formData,
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.success) {
              status.innerText = `✅ Registrasi sukses: ${data.result.user_id ?? userId}`;
            } else {
              status.innerText = `⚠️ Gagal: ${data.message}`;
            }
          })
          .catch((err) => {
            status.innerText = `❌ Gagal mengirim: ${err}`;
          });
      }
    </script>
  </body>
</html>
